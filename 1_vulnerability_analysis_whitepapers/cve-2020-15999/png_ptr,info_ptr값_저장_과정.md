### `png_ptr`, `info_ptr` 값 저장 과정

- `png_set_IHDR`함수에서 검증되지 않은 `width`와 `height` 값을 `info_ptr`에  값을 저장합니다.
- `png_set_IHDR` 함수의 호출 순서는 다음과 같습니다.
  - `png_read_info` → `png_handle_IHDR` → `png_set_IHDR`

```c
// pngshim.c
FT_LOCAL_DEF( FT_Error )
Load_SBit_Png( FT_GlyphSlot     slot,
                 FT_Int           x_offset,
                 FT_Int           y_offset,
                 FT_Int           pix_bits,
                 TT_SBit_Metrics  metrics,
                 FT_Memory        memory,
                 FT_Byte*         data,
                 FT_UInt          png_len,
                 FT_Bool          populate_map_and_metrics,
                 FT_Bool          metrics_only )
{
...
    png_read_info( png, info ); // [A]
    png_get_IHDR( png, info,    // [F]
                  &imgWidth, &imgHeight,
                  &bitdepth, &color_type, &interlace,
                  NULL, NULL );
...
}
```

- [A] : `png_read_info` 를 호출합니다.

```c
// pngread.c
void PNGAPI
png_read_info(png_structrp png_ptr, png_inforp info_ptr)
{
	 ...
   if (png_ptr == NULL || info_ptr == NULL)
      return;
	 ...
   for (;;)
   {
      png_uint_32 length = png_read_chunk_header(png_ptr);
      ...
      /* This should be a binary subdivision search or a hash for
       * matching the chunk name rather than a linear search.
       */
      if (chunk_name == png_IHDR)
         png_handle_IHDR(png_ptr, info_ptr, length); // [B]
			...
   }
}
```

- [B] : `png_handle_IHDR` 를 호출합니다.

```c
//third_party/libpng/pngrutil.c
void /* PRIVATE */
png_handle_IHDR(png_structrp png_ptr, png_inforp info_ptr, png_uint_32 length)
{
   png_byte buf[13];
   png_uint_32 width, height;
   int bit_depth, color_type, compression_type, filter_type;
   int interlace_type;
	 ...
	 png_crc_read(png_ptr, buf, 13); // [C]
	 ...
	 // [C-1] 
   width = png_get_uint_31(png_ptr, buf); 
   height = png_get_uint_31(png_ptr, buf + 4);
   bit_depth = buf[8];
   color_type = buf[9];
   compression_type = buf[10];
   filter_type = buf[11];
   interlace_type = buf[12];

   /* Set internal variables */
   png_ptr->width = width;
   png_ptr->height = height;
   png_ptr->bit_depth = (png_byte)bit_depth;
   png_ptr->interlaced = (png_byte)interlace_type;
   png_ptr->color_type = (png_byte)color_type;
#ifdef PNG_MNG_FEATURES_SUPPORTED
   png_ptr->filter_type = (png_byte)filter_type;
#endif
   png_ptr->compression_type = (png_byte)compression_type;

   /* Find number of channels */
   switch (png_ptr->color_type)
   {
			...
      case PNG_COLOR_TYPE_RGB_ALPHA:
         png_ptr->channels = 4;
         break;
   }

   /* Set up other useful info */
   png_ptr->pixel_depth = (png_byte)(png_ptr->bit_depth * png_ptr->channels);
   png_ptr->rowbytes = PNG_ROWBYTES(png_ptr->pixel_depth, png_ptr->width);
	 ...
   png_set_IHDR(png_ptr, info_ptr, width, height, bit_depth,
       color_type, interlace_type, compression_type, filter_type); // [D]
}
```

- [C], [C-1] : `png_handle_IHDR`함수에서는 `png_ptr`에 `png 헤더 구조체의 값`을 읽어와 저장합니다.
- [D] : `png_set_IHDR`을 호출합니다.

```c
// third_party/libpng/pngset.c
void PNGAPI
png_set_IHDR(png_const_structrp png_ptr, png_inforp info_ptr,
    png_uint_32 width, png_uint_32 height, int bit_depth,
    int color_type, int interlace_type, int compression_type,
    int filter_type)
{
	 ...
	 // [E]
   info_ptr->width = width;
   info_ptr->height = height;
   info_ptr->bit_depth = (png_byte)bit_depth;
   info_ptr->color_type = (png_byte)color_type;
   info_ptr->compression_type = (png_byte)compression_type;
   info_ptr->filter_type = (png_byte)filter_type;
   info_ptr->interlace_type = (png_byte)interlace_type;
	 ...
   info_ptr->pixel_depth = (png_byte)(info_ptr->channels * info_ptr->bit_depth);
   info_ptr->rowbytes = PNG_ROWBYTES(info_ptr->pixel_depth, width);
}
```

- [E] : `png_set_IHDR`함수에서는 `png_handle_IHDR`에서 읽어온 `png 헤더 구조체의 값`을 `info_ptr`에 저장합니다.

```c
png_uint_32 PNGAPI
png_get_IHDR(png_const_structrp png_ptr, png_const_inforp info_ptr,
    png_uint_32 *width, png_uint_32 *height, int *bit_depth,
    int *color_type, int *interlace_type, int *compression_type,
    int *filter_type)
{
   ...
   if (png_ptr == NULL || info_ptr == NULL)
      return (0);

   if (width != NULL)
       *width = info_ptr->width;

   if (height != NULL)
       *height = info_ptr->height;

   if (bit_depth != NULL)
       *bit_depth = info_ptr->bit_depth;

   if (color_type != NULL)
       *color_type = info_ptr->color_type;

   if (compression_type != NULL)
      *compression_type = info_ptr->compression_type;

   if (filter_type != NULL)
      *filter_type = info_ptr->filter_type;

   if (interlace_type != NULL)
      *interlace_type = info_ptr->interlace_type;
	 ...
   return (1);
}
```

- [F] : png 파일 헤더에서 읽어온 값을 `png_get_IHDR` 함수에서 각 변수에 저장합니다.