# CVE-2020-6449


ğŸ’¡ ì´ ë¬¸ì„œëŠ” Man Yue Moë‹˜ì˜ [GHSL-2020-040: Use After Free in Chrome WebAudio](https://securitylab.github.com/advisories/GHSL-2020-040-chrome/) ë¬¸ì„œë¥¼ ë²ˆì—­í•œ ë‚´ìš©ì…ë‹ˆë‹¤.   

ğŸ’¡ [+]ì€ ì œê°€ ì´í•´í•˜ëŠ”ë° í•„ìš”í–ˆë˜ ì¶”ê°€ì ì¸ ë‚´ìš©ì„ ì‘ì„±í•œ ê²ƒì…ë‹ˆë‹¤.   

## **Summary**

UaF inÂ `DeferredTaskHandler::BreakConnections(2)`

## **Product**


Chrome

## **CVE**


CVE-2020-6449

## **Tested Version**


Chrome version: master branch build 79956ba, asan build 80.3987.132 Operating System: Ubuntu 18.04

## **Details**


ì´ issueëŠ” issue 1057593ê³¼ ë™ì¼í•œ crashê°€ ë‚˜ì§€ë§Œ root causeì™€ fixê°€ ë‹¤ë¥´ë‹¤.

1057593ê³¼ ìœ ì‚¬í•˜ê²Œ `BaseAudioContext`ì˜ ì¤‘ì§€ì™€ `AudioScheduleSourceNode`ì˜ ì¤‘ì§€ê°€ ë™ì¼í•œ í€€í…€ì—ì„œ ë°œìƒí•˜ë©´ `BaseAudioContext`ê°€ ì¼ì‹œ ì¤‘ë‹¨ë˜ëŠ” ë™ì•ˆ `AudioScheduleSourceNode`ê°€ ì†Œë©¸ë  ìˆ˜ ìˆë‹¤. ì´ ì‹œì ì—ì„œ `DeferredTaskHandler`ì˜ `active_source_handlers_`[[1]](#1-chromium-code-search)ëŠ” `DeferredTaskHandler::BreakConnections`[[2]](#2-chromium-code-search)ì—ì„œ ì‚¬ìš©ë˜ê¸° ì „ì— í•´ë‹¹ `AudioScheduleSourceHandler`ë¥¼ í™œì„± ìƒíƒœë¡œ ìœ ì§€í•˜ëŠ” ì—­í• ì„ í•œë‹¤.

`DeferredTaskHandler::BreakConnections`ì˜ ì½”ë“œëŠ” ë¬µì‹œì ìœ¼ë¡œ `done_source_handlers_`ê°€ `active_source_handlers_`ì˜ í•˜ìœ„ ì§‘í•©ì´ë¯€ë¡œ `active_source_handlers_`ê°€ `finished_source_handlers_`ì˜ `raw pointer`ë¥¼ í™œì„± ìƒíƒœë¡œ ìœ ì§€í•œë‹¤ê³  ê°€ì •í•œë‹¤. (`active_source_handlers_.erase`ì—ì„œ ë³¼ ìˆ˜ ìˆë“¯ì´ `finished`ê°€ `active_source_handlers_`ì— í¬í•¨ë˜ì–´ ìˆë‹¤ê³  ê°€ì •í•¨)

ê·¸ëŸ¬ë‚˜ ë¬¸ì œëŠ” `active_source_handlers_`ê°€ `DeferredTaskHandler::ClearHandlersToBeDeleted` ë©”ì„œë“œ[[3]](#3-chromium-code-search)ì— ì˜í•´ ì§€ì›Œì§ˆ ìˆ˜ ìˆëŠ” ë°˜ë©´ `finished_source_handlers_` ëŠ” ë™ì‹œì— ì§€ì›Œì§€ì§€ ì•Šì•„ `finished_source_handlers_`ì— ëŒ•ê¸€ë§ í¬ì¸í„°ê°€ ë‚¨ê²Œ ë˜ì–´ `BreakConnections`ì—ì„œ `UaF`ê°€ ë°œìƒí•œë‹¤.

```cpp
**// void DeferredTaskHandler::BreakConnections()**
	for (auto* finished : finished_source_handlers_) {
      // Break connection first and then remove from the list because that can
      // cause the handler to be deleted.
      finished->BreakConnectionWithLock();     //<-- `active_source_handlers_` may have been cleared, and finished is already freed
      active_source_handlers_.erase(finished); //<-- assumes `active_source_handlers_` contains finished
    }

```

`ClearHandlersToBeDeleted`ë¥¼ í˜¸ì¶œí•˜ëŠ” `BaseAudioContext::Uninitialize`ë¥¼ íŠ¸ë¦¬ê±°í•˜ëŠ” ì»¨í…ìŠ¤íŠ¸ë¥¼ íŒŒê´´í•˜ë©´ `active_source_handlers_`ë¥¼ ì§€ìš´ ë‹¤ìŒ DeferredTaskHandler::BreakConnectionsë¥¼ íŠ¸ë¦¬ê±°í•˜ì—¬ UaFë¥¼ ë°œìƒì‹œí‚¬ ìˆ˜ ìˆë‹¤.

### **[1]** [Chromium Code Search](https://source.chromium.org/chromium/chromium/src/+/bf433ad6dcfcaac460512bb45a53d5a2ea5356f9:third_party/blink/renderer/modules/webaudio/deferred_task_handler.h;l=255;drc=67e598a2ae32101acac19318c0c56830c12a303f?originalUrl=https:%2F%2Fcs.chromium.org%2F)

![third_party/blink/renderer/modules/webaudio/deferred_task_handler.h](img/Untitled.png)

third_party/blink/renderer/modules/webaudio/deferred_task_handler.h

- **[+]**
    
    ### WTF::HashSet
    
    [Chromium Code Search](https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/platform/wtf/hash_set.h)
    
    baseë‚˜ std ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ìš°ì„ í•˜ì—¬ WTFì— ì •ì˜ëœ íƒ€ì…ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤. ê·¸ ì¤‘ ê°€ì¥ ì¸ê¸° ìˆëŠ” ê²ƒì€ vectors, **hashsets**, hashmaps, strings ì´ë‹¤. ë¸”ë§í¬ì—ì„œëŠ” WTF::Vector, **WTF::HashSet**, WTF::HashMAp, WTF::String, WTF::AtomicStringì„ std::vector, std::*set, std::*map, std::stringì„ ëŒ€ì‹ í•˜ì—¬ ì‚¬ìš©í•˜ì—¬ì•¼ í•œë‹¤.
    
    
    [WTF (Web Template Framework)](https://chromium.googlesource.com/chromium/src/+/refs/heads/main/third_party/blink/renderer/platform/wtf/README.md)
    

### **[2]** [Chromium Code Search](https://source.chromium.org/chromium/chromium/src/+/bf433ad6dcfcaac460512bb45a53d5a2ea5356f9:third_party/blink/renderer/modules/webaudio/deferred_task_handler.cc;l=83;drc=67e598a2ae32101acac19318c0c56830c12a303f?originalUrl=https:%2F%2Fcs.chromium.org%2F)

![third_party/blink/renderer/modules/webaudio/deferred_task_handler.cc](img/Untitled%201.png)

third_party/blink/renderer/modules/webaudio/deferred_task_handler.cc

- **[+]**
    
    ![third_party/blink/renderer/modules/webaudio/audio_node.cc](img/Untitled%202.png)
    
    third_party/blink/renderer/modules/webaudio/audio_node.cc
    
    finished_source_handlers_ë¥¼ ì°¸ì¡°í•˜ê³  ìˆëŠ” í¬ì¸í„°ì˜ ìˆ˜ë¥¼ ì¤„ì´ëŠ” ê²ƒìœ¼ë¡œ ì¶”ì¸¡ë¨ 
    

### **[3]** [Chromium Code Search](https://source.chromium.org/chromium/chromium/src/+/bf433ad6dcfcaac460512bb45a53d5a2ea5356f9:third_party/blink/renderer/modules/webaudio/deferred_task_handler.cc;l=361;drc=67e598a2ae32101acac19318c0c56830c12a303f;bpv=1;bpt=1?originalUrl=https:%2F%2Fcs.chromium.org%2F)

![third_party/blink/renderer/modules/webaudio/deferred_task_handler.cc](img/Untitled%203.png)

third_party/blink/renderer/modules/webaudio/deferred_task_handler.cc

### [+] **summary**
    
`DeferredTaskHandler::BreakConnections`ì—ì„œ raw pinter(finished)ì˜ reference countí•˜ë‚˜ì”© ì§€ìš´ ë‹¤ìŒ, raw pointer(finished)ë¥¼ eraseí•´ì¤€ë‹¤. ë§Œì•½ ì´ í•¨ìˆ˜ ì „ì—, `DeferredTaskHandler::ClearHandlersToBeDeleted` ì—ì„œ raw pointerë“¤ì„ ì €ì¥í•˜ê³  ìˆëŠ” hashsetì¸ active_source_handlers_ê°€ clear ëœë‹¤ë©´, raw pointer(finished)ë“¤ì€ ì „ë¶€ ëŒ•ê¸€ë§ í¬ì¸í„°ê°€ ë˜ì–´ì„œ UaFê°€ ë°œìƒí•  ìˆ˜ë„ ìˆë‹¤.
    

### **Impact**

Use-after-free in renderer.

## **Coordinated Disclosure Timeline**


- 09/03/2020 Reported asÂ [Chromium Issue 1059686](https://bugs.chromium.org/p/chromium/issues/detail?id=1059686)
- 18/03/2020Â [Fixed in version 80.0.3987.149](https://chromereleases.googleblog.com/2020/03/stable-channel-update-for-desktop_18.html)
    - [+] Patch[4c57222340cfb78edadf08532f4468c676df5395 - chromium/src.git - Git at Google](https://chromium.googlesource.com/chromium/src.git/+/4c57222340cfb78edadf08532f4468c676df5395)
	
        <img src="./img/Untitled%204.png" width="500" height="350" /><img src="./img/Untitled%204.png" width="500" height="350" />


        `finished_source_handlers_` ë¥¼ raw pointerê°€ ì•„ë‹ˆë¼ smart pointerì¸ base::scoped_refptr<>ë¡œ ê´€ë¦¬í•œë‹¤.
        
        ë˜í•œ ì‹¤ì§ì ìœ¼ë¡œ UaFê°€ ë°œìƒí•˜ëŠ” ê²ƒì„ ë§‰ê¸° ìœ„í•´ `DeferredTaskHandler::ClearHandlersToBeDeleted` ì—ì„œ active_source_handlers_ë¥¼ clearí•˜ê¸° ì „ì— finished_source_handlers_ë¶€í„° clearí•˜ëŠ” ì½”ë“œë¥¼ ì¶”ê°€í•˜ì˜€ë‹¤.
        
        ### reference countë¥¼ ê´€ë¦¬í•´ì£¼ëŠ” ì´ìœ 
        
        ê°€ë¹„ì§€ ì»¬ë ‰í„° ì•Œê³ ë¦¬ì¦˜ ì¤‘ì— reference countingì„ ì´ìš©í•œ ì•Œê³ ë¦¬ì¦˜ì´ ìˆë‹¤. í•´ë‹¹ ê°ì²´ì˜ reference countê°€ 0ì´ ë˜ë©´ ë©”ëª¨ë¦¬ì—ì„œ í•´ì œì‹œí‚¨ë‹¤. ì´ë¥¼ ìœ„í•´ í¬ì¸í„°ë¥¼ í•´ì œì‹œí‚¬ë•Œ reference countë¥¼ ê´€ë¦¬í•œë‹¤.
        
        ### base::scoped_refptr
        
        [Smart Pointer Guidelines - The Chromium Projects](https://www.chromium.org/developers/smart-pointer-guidelines)
        
        - Chromiumì—ì„œ ì‚¬ìš©í•˜ëŠ” í¬ì¸í„°ëŠ” ì£¼ë¡œ `std::unique_ptr<>`ê³¼ `base::scoped_refptr<>`ì´ë‹¤.
        - base::scoped_refptr<> ì€ `std::shared_ptr<>`ê³¼ ë¹„ìŠ·í•œ ê°œë…ì´ë‹¤.
        - **std::unique_ptr<>**
            - ê°ì²´ì— ëŒ€í•œ ìœ ì¼í•œ "ì†Œìœ ê¶Œ"ì´ ìˆìŒì„ ë³´ì¥í•˜ëŠ” í¬ì¸í„°
            - ë³µì‚¬ ë¶ˆê°€ëŠ¥, ì†Œìœ ê¶Œ ì—†ì´ ê°ì²´ ì‚­ì œ ë¶ˆê°€
        - **std::shared_ptr<>**
            - ê°ì²´ë¥¼ ì°¸ì¡°í•˜ê³  ìˆëŠ” í¬ì¸í„°ì˜ ê°œìˆ˜ë¥¼ ë³´ìœ í•œ í¬ì¸í„°
            - í¬ì¸í„°ì˜ ê°œìˆ˜ê°€ 0ì¼ ê²½ìš°, deleteë¡œ ë©”ëª¨ë¦¬ í•´ì œ ***(reference count ë°©ì‹)***
                
                

## **Credit**


This issue was discovered and reported by GHSL team memberÂ [@m-y-mo (Man Yue Mo)](https://github.com/m-y-mo).

## **Contact**


You can contact the GHSL team atÂ `securitylab@github.com`, please include theÂ `GHSL-2020-040`Â in any communication regarding this issue.
